<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETHIO BINGO GOLD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #facc15; --bg: #0f172a; --card: #1e293b; --green: #22c55e; --red: #ef4444; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding-bottom: 50px; }
        .header { display: flex; justify-content: space-between; padding: 15px; background: #111827; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--gold); }
        .page { display: none; padding: 15px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Bingo Grid */
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; background: #cbd5e1; padding: 8px; border-radius: 10px; max-width: 320px; margin: 15px auto; }
        .cell { aspect-ratio: 1; background: white; color: #1e293b; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .cell.marked { background: var(--red) !important; color: white !important; border-radius: 50%; transform: scale(0.9); }
        
        /* Live Ball Area */
        .live-ball-wrap { display: flex; flex-direction: column; align-items: center; margin: 10px 0; }
        .ball { width: 70px; height: 70px; background: radial-gradient(circle at 30% 30%, var(--gold), #a16207); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; color: #000; box-shadow: 0 0 15px var(--gold); border: 3px solid #fff; }

        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-green { background: var(--green); color: white; }
        
        .price-tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .tab { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; background: #0f172a; color: white; border: 1px solid #444; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="header">
        <div>áˆ°áˆ‹áˆ <b id="p-name">...</b></div>
        <div id="u-bal" style="color:var(--green); font-weight:bold;">0.00 ETB</div>
    </div>

    <div id="home-page" class="page active">
        <h3 style="color:var(--gold)">á‹¨áŠ«áˆ­á‰´áˆ‹ á‹‹áŒ‹ á‹­áˆáˆ¨áŒ¡</h3>
        <div class="price-tabs">
            <div class="tab" onclick="openGame(10)"><b>10</b><br><small>ETB</small></div>
            <div class="tab" onclick="openGame(20)"><b>20</b><br><small>ETB</small></div>
            <div class="tab" onclick="openGame(50)"><b>50</b><br><small>ETB</small></div>
            <div class="tab" onclick="openGame(100)"><b>100</b><br><small>ETB</small></div>
            <div class="tab" onclick="openGame(500)"><b>500</b><br><small>ETB</small></div>
            <div class="tab" onclick="openGame(1000)"><b>1000</b><br><small>ETB</small></div>
        </div>

        <div style="background:var(--card); padding:15px; border-radius:12px; margin-top:20px;">
            <h4 style="margin:0; color:var(--gold)">ğŸ“¥ á‰¥áˆ­ áˆˆáˆ›áˆµáŒˆá‰£á‰µ</h4>
            <p style="font-size:0.8rem">á‰´áˆŒá‰¥áˆ­: <b>0991243423</b></p>
            <input type="text" id="tid" placeholder="á‹¨áŒá‰¥á‹­á‰µ á‰áŒ¥áˆ­ (TID)">
            <button class="btn btn-gold" onclick="submitPay()">á‹¨áŠ­áá‹« áˆ›áˆ¨áŒ‹áŒˆáŒ« áˆ‹áŠ­</button>
        </div>

        <div id="admin-link" style="display:none; margin-top:20px;">
            <button class="btn btn-green" onclick="showPage('admin-page')">ğŸ”‘ á‹³áŠ› áŒˆáŒ½ (Admin)</button>
        </div>
    </div>

    <div id="game-page" class="page">
        <div class="live-ball-wrap">
            <span>á‹¨á‹ˆáŒ£ á‰áŒ¥áˆ­</span>
            <div class="ball" id="live-ball">?</div>
        </div>
        <div class="bingo-grid" id="bingo-board"></div>
        <button class="btn btn-green" onclick="checkBingo()">BINGO! (á‰ áŒ¥áŒ¥)</button>
        <button class="btn" style="background:var(--card); color:white;" onclick="showPage('home-page')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <div id="admin-page" class="page">
        <h3 style="color:var(--gold)">á‹¨á‹³áŠ› áˆ˜á‰†áŒ£áŒ áˆªá‹«</h3>
        <div class="live-ball-wrap">
            <div class="ball" id="admin-ball">?</div>
        </div>
        <button class="btn btn-gold" onclick="drawNumber()">á‰áŒ¥áˆ­ áŠ á‹áŒ£</button>
        <button class="btn" style="background:var(--red); color:white; margin-top:20px;" onclick="resetDrawn()">áˆáˆ‰áŠ•áˆ á‰áŒ¥áˆ­ áŠ áŒ¥á‹ (Reset)</button>
        
        <div id="admin-requests" style="margin-top:20px; text-align:left;">
            <h4>á‹¨áŠ­áá‹« áŒ¥á‹«á‰„á‹á‰½</h4>
            <div id="req-list">áŒ¥á‹«á‰„ á‹¨áˆˆáˆ...</div>
        </div>
        <button class="btn" style="background:var(--card); color:white;" onclick="showPage('home-page')">á‹ˆá‹° áˆ˜áŠáˆ»</button>
    </div>

    <script>
        const ADMIN_ID = 8431270634;
        const firebaseConfig = { databaseURL: "https://dagi-bingo-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myBal = 0;
        let drawnNumbers = [];
        const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 999;

        // --- 1. Sync Data ---
        if(uid == ADMIN_ID) document.getElementById('admin-link').style.display = 'block';
        document.getElementById('p-name').innerText = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "User";

        db.ref('users/' + uid + '/bal').on('value', (s) => {
            myBal = s.val() || 0;
            document.getElementById('u-bal').innerText = myBal.toFixed(2) + " ETB";
        });

        db.ref('game/drawn').on('value', (s) => {
            drawnNumbers = s.val() || [];
            const last = drawnNumbers[drawnNumbers.length - 1] || "?";
            document.getElementById('live-ball').innerText = last;
            document.getElementById('admin-ball').innerText = last;
        });

        // --- 2. Game Functions ---
        function openGame(price) {
            if(myBal < price) return alert("áŠ¥á‰£áŠ­á‹ áˆ˜áŒ€áˆ˜áˆªá‹« áˆ‚áˆ³á‰¥ á‹«áˆµáŒˆá‰¡!");
            
            // á‰¥áˆ­ á‰€áŠ•áˆ¥
            db.ref('users/' + uid + '/bal').set(myBal - price);
            
            showPage('game-page');
            generateBoard();
        }

        function generateBoard() {
            const board = document.getElementById('bingo-board');
            board.innerHTML = "";
            let nums = Array.from({length: 75}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            for(let i=0; i<25; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = nums[i];
                cell.onclick = function() { 
                    this.classList.toggle('marked');
                    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                };
                board.appendChild(cell);
            }
        }

        // --- 3. Admin Functions ---
        function drawNumber() {
            if(drawnNumbers.length >= 75) return alert("á‰áŒ¥áˆ®á‰½ áŠ áˆá‰€á‹‹áˆ!");
            let n;
            do { n = Math.floor(Math.random() * 75) + 1; } while(drawnNumbers.includes(n));
            drawnNumbers.push(n);
            db.ref('game/drawn').set(drawnNumbers);
        }

        function resetDrawn() {
            if(confirm("áˆáˆ‰áŠ•áˆ á‹¨á‹ˆáŒ¡ á‰áŒ¥áˆ®á‰½ áˆ›áŒ¥á‹á‰µ á‰µáˆáˆáŒ‹áˆˆáˆ…?")) db.ref('game/drawn').set([]);
        }

        // --- 4. Payment Functions ---
        function submitPay() {
            const tid = document.getElementById('tid').value;
            if(!tid) return alert("áŠ¥á‰£áŠ­á‹ TID á‹«áˆµáŒˆá‰¡");
            db.ref('deposit_requests').push({ uid, name: tg.initDataUnsafe.user.first_name, tid, status: 'pending' });
            alert("áŒ¥á‹«á‰„ á‰°áˆáŠ³áˆ!");
            document.getElementById('tid').value = "";
        }

        // --- Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId == 'admin-page') loadRequests();
        }

        function loadRequests() {
            db.ref('deposit_requests').on('value', (s) => {
                const list = document.getElementById('req-list');
                list.innerHTML = "";
                s.forEach(child => {
                    const r = child.val();
                    if(r.status == 'pending') {
                        let d = document.createElement('div');
                        d.style = "background:#111827; padding:10px; margin-bottom:5px; border-radius:5px;";
                        d.innerHTML = `${r.name} (TID: ${r.tid}) <br> 
                        <button onclick="approve('${child.key}','${r.uid}')" style="background:var(--green); color:white; border:none; padding:5px; border-radius:3px;">áŠ áŒ½á‹µá‰…</button>`;
                        list.appendChild(d);
                    }
                });
            });
        }

        function approve(key, userUid) {
            let amt = prompt("á‹¨á‰¥áˆ­ áˆ˜áŒ áŠ• á‹«áˆµáŒˆá‰¡:", "200");
            if(amt) {
                db.ref('users/'+userUid+'/bal').transaction(b => (b||0) + parseFloat(amt));
                db.ref('deposit_requests/'+key).update({status:'approved'});
            }
        }

        function checkBingo() {
            alert("á‰¢áŠ•áŒ áˆˆá‹³áŠ›á‹ á‰°áˆáŠ³áˆ! á‰áŒ¥áˆ®á‰¹áŠ• áŠ¥á‹«áˆ¨áŒ‹áŒˆáŒ  áŠá‹á¢");
        }
    </script>
</body>
</html>

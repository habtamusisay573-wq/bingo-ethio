<script>
    const ADMIN_ID = 8431270634;
    const firebaseConfig = { databaseURL: "https://dagi-bingo-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.expand();

    let myBal = 0, drawn = [], autoInterval = null, selectedPrice = 0, currentCard = 0;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : Date.now();
    const uName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "á‰°áŒ«á‹‹á‰½";

    document.getElementById('u-name').innerText = uName;
    if(uid == ADMIN_ID) document.getElementById('admin-btn').style.display = 'block';

    // ğŸ’° á‰£áˆ‹áŠ•áˆµ áˆ˜áŠ¨á‰³á‰°á‹«
    db.ref('users/'+uid+'/bal').on('value', s => { 
        myBal = s.val() || 0; 
        document.getElementById('u-bal').innerText = myBal.toFixed(2) + " ETB"; 
    });

    // ğŸ”¢ á‹¨á‹ˆáŒ¡ á‰áŒ¥áˆ®á‰½ áˆ˜áŠ¨á‰³á‰°á‹«
    db.ref('game/drawn').on('value', s => { 
        drawn = s.val() || [];
        document.getElementById('live-ball').innerText = drawn[drawn.length-1] || "?";
        document.getElementById('admin-ball').innerText = drawn[drawn.length-1] || "?";
        
        // á‰ áˆ«áˆµ-áˆ°áˆ­ Hint áŠ¥áŠ•á‹²á‹«á‹°áˆ­áŒ
        document.querySelectorAll('.cell').forEach(cell => {
            if(drawn.includes(parseInt(cell.innerText))) cell.classList.add('hint');
        });
    });

    // ğŸŸ¢ áŒˆáŒ½ á‹¨áˆ˜á‰€á‹¨áˆ­ á‰°áŒá‰£áˆ­
    function showPage(p) { 
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active')); 
        document.getElementById(p).classList.add('active'); 
    }

    // ğŸŸ¢ ááˆ­áˆ á‹¨áˆ›áˆ³á‹« á‰°áŒá‰£áˆ­
    function showForm(id) { 
        document.getElementById('dep-form').style.display = 'none'; 
        document.getElementById('wd-form').style.display = 'none'; 
        document.getElementById(id).style.display = 'block'; 
    }

    // ğŸ’³ á‹²á–á‹šá‰µ áˆˆáˆ˜áŒ á‹¨á‰… (áŠ áˆáŠ• á‹­áˆ°áˆ«áˆ!)
    function sendPayment() {
        let tid = document.getElementById('tid').value;
        if(!tid) return alert("áŠ¥á‰£áŠ­áˆ… TID áŠ áˆµáŒˆá‰£!");
        db.ref('all_requests').push({ uid, name: uName, tid: tid, type: 'DEP', status: 'pending', time: Date.now() });
        alert("á‹¨áŠ­áá‹« áŒ¥á‹«á‰„áˆ… á‰°áˆáŠ³áˆ! á‹³áŠ›á‹ áŠ¥áˆµáŠªá‹«áŒ¸á‹µá‰… á‰ á‰µá‹•áŒáˆµá‰µ áŒ á‰¥á‰…á¢");
        document.getElementById('tid').value = "";
    }

    // ğŸ•¹ áŠ«áˆ­á‰´áˆ‹ áˆˆáˆ˜áˆáˆ¨áŒ¥
    function goToCardPicker(p) {
        if(myBal < p) return alert("á‰£áˆ‹áŠ•áˆµáˆ… áŠ á‹­á‰ á‰ƒáˆ! áŠ¥á‰£áŠ­áˆ… áˆ˜áŒ€áˆ˜áˆªá‹« á‰¥áˆ­ áŠ áˆµáŒˆá‰£á¢");
        selectedPrice = p;
        showPage('picker-page');
        const list = document.getElementById('card-list');
        list.innerHTML = "";
        for(let i=1; i<=100; i++) {
            let b = document.createElement('button');
            b.className = 'btn'; b.style.background = 'var(--card)'; b.style.color = 'white';
            b.innerText = i;
            b.onclick = () => startGame(i);
            list.appendChild(b);
        }
    }

    // ğŸ° áŒ¨á‹‹á‰³ áˆˆáˆ˜áŒ€áˆ˜áˆ­
    function startGame(n) {
        currentCard = n;
        db.ref('users/'+uid+'/bal').set(myBal - selectedPrice);
        document.getElementById('card-label').innerText = "áŠ«áˆ­á‰´áˆ‹ #" + n;
        showPage('game-page');
        const board = document.getElementById('board');
        board.innerHTML = "";
        let nums = Array.from({length:75},(_,i)=>i+1).sort(()=>Math.random()-0.5).slice(0,24);
        for(let i=0; i<25; i++) {
            let c = document.createElement('div'); c.className = 'cell';
            if(i === 12) { c.innerText = "FREE"; c.classList.add('free'); }
            else { c.innerText = nums.pop(); }
            c.onclick = function() {
                if(drawn.includes(parseInt(this.innerText)) || this.classList.contains('free')) {
                    this.classList.toggle('marked');
                }
            };
            board.appendChild(c);
        }
    }

    // ğŸ† á‰¢áŠ•áŒ áˆˆáˆ›áˆˆá‰µ (áŠ áˆáŠ• á‹­áˆ°áˆ«áˆ!)
    function claimBingo() {
        db.ref('all_requests').push({ uid, name: uName, card: currentCard, type: 'BINGO', status: 'pending', time: Date.now() });
        alert("á‰¢áŠ•áŒ áŒ¥á‹«á‰„ á‰°áˆáŠ³áˆ! á‹³áŠ›á‹ áŠ«áˆ­á‰´áˆ‹áˆ…áŠ• áŠ¥á‹¨áˆ˜áˆ¨áˆ˜áˆ¨ áŠá‹á¢");
    }

    // ğŸ”§ á‹³áŠ› áŒˆáŒ½ áˆ‹á‹­ á‹«áˆ‰ áˆµáˆ«á‹á‰½
    function showAdmin() {
        showPage('admin-page');
        db.ref('all_requests').on('value', s => {
            const list = document.getElementById('admin-req-list');
            list.innerHTML = "<h4>á‹¨áˆ˜áŒ¡ áŒ¥á‹«á‰„á‹á‰½</h4>";
            s.forEach(child => {
                let r = child.val();
                if(r.status === 'pending') {
                    let div = document.createElement('div');
                    div.className = 'tx-card';
                    div.innerHTML = `
                        <b>${r.type}</b>: ${r.name} (${r.tid || r.card})
                        <button onclick="approve('${child.key}', '${r.uid}', '${r.type}')" style="background:var(--green); color:white; border:none; padding:5px; border-radius:5px; margin-left:10px;">áŠ áŒ½á‹µá‰…</button>
                    `;
                    list.appendChild(div);
                }
            });
        });
    }

    // âœ… áŒ¥á‹«á‰„ áˆˆáˆ›áŒ½á‹°á‰… (á‰áˆá‰ á‹­áˆ„ áŠá‹!)
    function approve(key, user_id, type) {
        if(type === 'DEP') {
            let amount = prompt("áˆµáŠ•á‰µ á‰¥áˆ­ á‹­áˆáˆ‹áˆˆá‰µ?");
            if(amount) {
                db.ref('users/'+user_id+'/bal').transaction(current => (current || 0) + parseFloat(amount));
                db.ref('all_requests/'+key).update({status: 'approved'});
                alert("á‰¥áˆ­ á‰°áˆáˆá‰·áˆ!");
            }
        } else if(type === 'BINGO') {
            let prize = prompt("á‹¨áˆ½áˆáˆ›á‰µ áˆ˜áŒ áŠ•:");
            if(prize) {
                db.ref('users/'+user_id+'/bal').transaction(current => (current || 0) + parseFloat(prize));
                db.ref('all_requests/'+key).update({status: 'approved'});
                alert("áˆ½áˆáˆ›á‰µ á‰°áˆáŠ³áˆ!");
            }
        }
    }

    function drawSingle() {
        let n; do { n = Math.floor(Math.random()*75)+1; } while(drawn.includes(n));
        drawn.push(n); db.ref('game/drawn').set(drawn);
    }

    function toggleAuto() {
        const b = document.getElementById('auto-btn');
        if(autoInterval) { clearInterval(autoInterval); autoInterval=null; b.innerText="Auto áŒ€áˆáˆ­"; }
        else { autoInterval = setInterval(drawSingle, 4000); b.innerText="áŠ á‰áˆ"; }
    }

    function resetGame() { if(confirm("áˆáˆ‰áŠ•áˆ á‰áŒ¥áˆ®á‰½ áˆ‹áŒ¥á‹?")) db.ref('game/drawn').set([]); }
</script>
